# syntax=docker/dockerfile:1
FROM python:3.12-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    POETRY_VERSION=2.2.1

RUN apt-get update && apt-get install -y --no-install-recommends build-essential curl git nodejs npm gettext && rm -rf /var/lib/apt/lists/*

RUN pip install --no-cache-dir poetry==${POETRY_VERSION}

WORKDIR /app

COPY pyproject.toml README.md ./
RUN poetry config virtualenvs.create false \
    && poetry install --no-interaction --no-ansi --no-root

COPY package.json ./
RUN npm install --no-audit --no-fund

COPY checktick_app ./checktick_app
COPY manage.py ./
COPY locale ./locale
# Install the current project now that sources are present
RUN poetry install --no-interaction --no-ansi

# Build CSS in the container on startup to pick up live changes
# For dev weâ€™ll run npm install/build at runtime so host volume overrides work

ENV DJANGO_SETTINGS_MODULE=checktick_app.settings
ENV PORT=8000

# Do not EXPOSE or run collectstatic; dev serves via runserver

CMD ["sh", "-lc", "npm install && npm run build:css && python manage.py migrate && python manage.py sync_nhs_dd_datasets && python manage.py runserver 0.0.0.0:${PORT}"]

{% extends 'base.html' %}
{% load i18n static survey_extras %}
{% block head_theme_overrides %}
  {% if survey.style.theme_css_light or survey.style.theme_css_dark %}
  <style>
    {% if survey.style.theme_css_light %}
    [data-theme="checktick-light"] {
      {{ survey.style.theme_css_light|safe }}
    }
    {% endif %}
    {% if survey.style.theme_css_dark %}
    [data-theme="checktick-dark"] {
      {{ survey.style.theme_css_dark|safe }}
    }
    {% endif %}
  </style>
  {% endif %}
  {% if survey.style.font_css_url %}
    <link href="{{ survey.style.font_css_url }}" rel="stylesheet" />
  {% endif %}
{% endblock %}
{% block title %}{% trans "Groups" %} - {{ survey.name }}{% endblock %}
{% block content %}
<div class="prose max-w-none">
  {% include 'components/breadcrumbs.html' with crumb1_label="Survey Dashboard" crumb1_href="/surveys/"|add:survey.slug|add:"/dashboard/" crumb2_label="Question Groups" %}
  <h1 class="inline-flex items-center gap-2 w-full text-base-content">
    {% include "components/icons/documents.html" with classes="w-7 h-7 text-base-content" %}
    <span>{% blocktrans %}Question Groups for {{ survey }}{% endblocktrans %}</span>
  </h1>
  <p class="mt-2 text-sm opacity-80 w-full">{% blocktrans %}Question Groups are reusable sets of questions. Arrange them here to control the order in which participants see question sets. You can also mark a set of groups as a repeating entity (e.g. People or Visits) directly here—no separate collections screen required.{% endblocktrans %}</p>
</div>

<div class="mt-4">

  <div class="space-y-3">
    <div class="alert shadow-sm bg-primary text-primary-content">
      <div>
        {% include "components/icons/repeat.html" with classes="w-5 h-5 text-primary-content" %}
      </div>
      <div class="text-sm">
        {% trans "Tip: Select groups by clicking their row or checkbox, then click ‘Create repeat’ to set a name. Selected rows are highlighted and show a small repeat icon." %}
      </div>
    </div>
    <ul id="groups-draggable" class="orderable-list w-full flex flex-col gap-3" aria-label="Reorder groups" data-reorder-url="/surveys/{{ survey.slug }}/groups/reorder" data-can-edit="{{ can_edit|yesno:'true,false' }}">
      {% for g in groups %}
        {% with info=repeat_info|get_item:g.id %}
        <li class="w-full" data-gid="{{ g.id }}" data-repeat="{{ info.is_repeated|default_if_none:False|yesno:'1,0' }}" title="{{ info.tooltip }}">
          <div class="w-full bg-base-100 rounded-lg border border-base-300 p-3 selectable-group hover:border-primary cursor-pointer transition-colors {% if info.is_repeated %}ring-1 ring-primary/40 bg-primary/5{% endif %}">
            <div class="flex items-center gap-3">
              {% if can_edit %}
              <button type="button" class="drag-handle inline-flex items-center justify-center w-7 h-7 mr-1 rounded-md text-primary border border-primary/30 hover:bg-primary/20 shrink-0 cursor-move" style="background-color: color-mix(in oklch, var(--p) 12%, transparent);" aria-label="Drag to reorder" title="Drag to reorder">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48" fill="currentColor" aria-hidden="true" focusable="false"><path d="M14 20h20v-4H14v4Zm0 6h20v-4H14v4Zm0 6h20v-4H14v4Z"/></svg>
              </button>
              {% endif %}
              {% if can_edit %}
              <input type="checkbox" class="checkbox checkbox-sm select-checkbox" aria-label="Select group" />
              {% endif %}
              <div class="q-number badge badge-primary badge-sm shrink-0">{{ forloop.counter }}</div>
              <div class="flex-1 min-w-0 flex items-center gap-2">
                <a class="font-medium link link-accent" href="/surveys/{{ survey.slug }}/builder/groups/{{ g.id }}/">{{ g.name }}</a>
                <span class="sel-repeat-icon hidden tooltip" data-tip="{% trans "Selected for repeat" %}">
                  {% include "components/icons/repeat.html" with classes="w-4 h-4 opacity-70" %}
                </span>
                {% if g.description %}<div class="text-sm opacity-70">{{ g.description }}</div>{% endif %}
              </div>
              {% if info.is_repeated %}
                <div class="tooltip" data-tip="{{ info.tooltip }}">
                  <div class="badge badge-info shrink-0 self-center inline-flex items-center gap-1">
                    {% include "components/icons/repeat.html" with classes="w-4 h-4" %}
                    <span>{% trans "Repeats" %}</span>
                  </div>
                </div>
                {% if can_edit %}
                <form method="post" action="/surveys/{{ survey.slug }}/groups/{{ g.id }}/repeat/remove" class="shrink-0" onsubmit="return confirm('{% trans "Remove this group from its repeat?" %}');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-xs btn-ghost" title="{% trans "Remove repeat" %}">
                    ✕
                  </button>
                </form>
                {% endif %}
              {% else %}
                <div class="badge badge-neutral shrink-0 self-center">{% blocktrans count counter=g.q_count|default:0 %}{{ counter }} question{% plural %}{{ counter }} questions{% endblocktrans %}</div>
              {% endif %}
              {% if can_edit %}
              <form method="post" action="/surveys/{{ survey.slug }}/groups/{{ g.id }}/delete" onsubmit="return confirm('{% trans "Delete this group?" %}');" class="shrink-0">
                {% csrf_token %}
                <button class="btn btn-sm btn-warning" type="submit">{% trans "Delete" %}</button>
              </form>
              {% endif %}
            </div>
          </div>
        </li>
        {% endwith %}
      {% empty %}
        <li class="opacity-70">{% trans "No groups yet. Create one to get started." %}</li>
      {% endfor %}
    </ul>
  <div class="flex flex-wrap gap-2 items-center sticky top-0 z-40 bg-base-200/95 backdrop-blur supports-[backdrop-filter]:bg-base-200/70 py-2">
  {% if can_edit %}
  <button id="create-repeat-btn" class="btn btn-secondary btn-sm inline-flex items-center gap-2" type="button" disabled>
    {% include "components/icons/repeat.html" with classes="w-4 h-4" %}
    <span>{% trans "Create repeat from selection" %}</span>
  </button>
  <span id="selection-toolbar" class="text-sm opacity-80 hidden">
    <span id="selection-count">0</span> {% trans "selected" %}
    <button type="button" id="clear-selection" class="btn btn-ghost btn-xs ml-2">{% trans "Clear" %}</button>
  </span>
      {% endif %}
      <a class="btn btn-ghost btn-sm" href="/surveys/{{ survey.slug }}/dashboard/">{% trans "Back to dashboard" %}</a>
      <a class="btn btn-ghost btn-sm" href="/docs/groups-view/" target="_blank" rel="noopener noreferrer">{% trans "Help" %}</a>
    </div>
  </div>
</div>

<div class="flex flex-wrap items-center gap-3 mb-4 relative z-[9999]">
    {% if can_edit %}
    <form method="post" action="/surveys/{{ survey.slug }}/groups/create" class="inline-flex">
      {% csrf_token %}
      <div class="join">
        <input id="create-group-name" class="input input-bordered join-item" name="name" placeholder="{% trans "New group name" %}" required />
        <button id="create-group-submit" class="btn join-item btn-primary" type="submit" disabled>{% trans "Create new question group" %}</button>
      </div>
    </form>
    {% endif %}
  </div>

    {% if can_edit %}
    <dialog id="repeat-modal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">{% trans "Create repeat" %}</h3>
        <form method="post" action="/surveys/{{ survey.slug }}/groups/repeat/create" id="repeat-form">
          {% csrf_token %}
          <input type="hidden" name="group_ids" id="repeat-group-ids" />
          <div class="mt-2">
            <label class="label">{% trans "Repeat name" %}</label>
            <input class="input input-bordered w-full" name="name" required />
          </div>
          <div class="mt-2 grid grid-cols-2 gap-3">
            <div>
              <label class="label">{% trans "Minimum items" %}</label>
              <input class="input input-bordered w-full" name="min_count" type="number" min="0" value="0" />
            </div>
            <div>
              <label class="label">{% trans "Maximum items" %}</label>
              <select class="select select-bordered w-full" name="max_count">
                <option value="">{% trans "Unlimited" %}</option>
                {% int_range 1 10 as nums %}
                {% for n in nums %}
                <option value="{{ n }}">{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          {% if existing_repeats %}
          <div class="mt-2">
            <label class="label">{% trans "Nest under existing (optional)" %}</label>
            <select class="select select-bordered w-full" name="parent_id">
              <option value="">—</option>
              {% for c in existing_repeats %}
              <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
            <p class="text-xs opacity-70 mt-1">{% trans "Nesting is limited to one level." %}</p>
          </div>
          {% endif %}
          <div class="modal-action">
            <button class="btn" type="button" id="repeat-cancel-btn">{% trans "Cancel" %}</button>
            <button class="btn btn-primary" type="submit">{% trans "Create" %}</button>
          </div>
        </form>
      </div>
    </dialog>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="{% static 'js/groups.js' %}?v={{ build.commit|default:build.timestamp }}"></script>
  <script src="{% static 'js/groups-page.js' %}?v={{ build.commit|default:build.timestamp }}"></script>
{% endblock %}

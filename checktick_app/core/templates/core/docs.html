{% extends "base.html" %}
{% block title %}Documentation Â· {{ block.super }}{% endblock %}
{% block content %}
<div class="grid grid-cols-12 gap-6">
  <aside class="col-span-12 lg:col-span-3">
    <div class="card bg-base-100 shadow sticky top-4">
      <div class="card-body p-4">
        <h2 class="card-title text-lg mb-2">Documentation</h2>
        <nav class="docs-nav" style="max-height: calc(100vh - 12rem); overflow-y: auto;">
          {% for category in pages %}
            <div class="docs-category mb-3" data-category="{{ category.title|slugify }}">
              <button class="docs-category-toggle w-full flex items-center justify-between text-left font-semibold text-sm px-2 py-1 rounded hover:bg-base-200 transition-colors"
                      aria-expanded="true"
                      aria-controls="category-{{ category.title|slugify }}">
                <span>
                  {% if category.icon %}<span class="mr-1">{{ category.icon }}</span>{% endif %}
                  {{ category.title }}
                </span>
                <svg class="docs-chevron w-4 h-4 transition-transform duration-200" 
                     fill="none" 
                     stroke="currentColor" 
                     viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <ul class="docs-category-items menu menu-sm pl-2 mt-1" 
                  id="category-{{ category.title|slugify }}"
                  style="display: block;">
                {% for page in category.pages %}
                  <li>
                    <a class="text-sm {% if active_slug == page.slug %}active font-semibold{% endif %}"
                       href="{% url 'core:docs_page' slug=page.slug %}">
                      {{ page.title }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endfor %}
        </nav>
      </div>
    </div>
  </aside>
  <section class="col-span-12 lg:col-span-9">
    <article class="prose max-w-none">
      {{ html|safe }}
    </article>
  </section>
</div>

<script>
(function() {
  'use strict';
  
  const STORAGE_KEY = 'docs-collapsed-categories';
  
  // Get collapsed categories from localStorage
  function getCollapsedCategories() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : [];
    } catch (e) {
      return [];
    }
  }
  
  // Save collapsed categories to localStorage
  function saveCollapsedCategories(collapsed) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(collapsed));
    } catch (e) {
      // Ignore localStorage errors
    }
  }
  
  // Find which category contains the active page
  function getActiveCategorySlug() {
    const activeLink = document.querySelector('.docs-category-items a.active');
    if (activeLink) {
      const category = activeLink.closest('.docs-category');
      return category ? category.dataset.category : null;
    }
    return null;
  }
  
  // Initialize collapsible categories
  function initCollapsibleCategories() {
    const categories = document.querySelectorAll('.docs-category');
    const collapsedCategories = getCollapsedCategories();
    const activeCategorySlug = getActiveCategorySlug();
    
    categories.forEach(function(category) {
      const toggle = category.querySelector('.docs-category-toggle');
      const items = category.querySelector('.docs-category-items');
      const chevron = toggle.querySelector('.docs-chevron');
      const categorySlug = category.dataset.category;
      
      // Collapse category if it was previously collapsed AND it's not the active category
      const shouldCollapse = collapsedCategories.includes(categorySlug) && 
                            categorySlug !== activeCategorySlug;
      
      if (shouldCollapse) {
        items.style.display = 'none';
        toggle.setAttribute('aria-expanded', 'false');
        chevron.style.transform = 'rotate(-90deg)';
      }
      
      // Toggle category on click
      toggle.addEventListener('click', function() {
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        
        if (isExpanded) {
          // Collapse
          items.style.display = 'none';
          toggle.setAttribute('aria-expanded', 'false');
          chevron.style.transform = 'rotate(-90deg)';
          
          // Add to collapsed list
          if (!collapsedCategories.includes(categorySlug)) {
            collapsedCategories.push(categorySlug);
            saveCollapsedCategories(collapsedCategories);
          }
        } else {
          // Expand
          items.style.display = 'block';
          toggle.setAttribute('aria-expanded', 'true');
          chevron.style.transform = 'rotate(0deg)';
          
          // Remove from collapsed list
          const index = collapsedCategories.indexOf(categorySlug);
          if (index > -1) {
            collapsedCategories.splice(index, 1);
            saveCollapsedCategories(collapsedCategories);
          }
        }
      });
    });
  }
  
  // Initialize on DOMContentLoaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCollapsibleCategories);
  } else {
    initCollapsibleCategories();
  }
})();
</script>

<style>
.docs-nav::-webkit-scrollbar {
  width: 6px;
}

.docs-nav::-webkit-scrollbar-track {
  background: transparent;
}

.docs-nav::-webkit-scrollbar-thumb {
  background: oklch(var(--bc) / 0.2);
  border-radius: 3px;
}

.docs-nav::-webkit-scrollbar-thumb:hover {
  background: oklch(var(--bc) / 0.3);
}

.docs-category-toggle:focus {
  outline: 2px solid oklch(var(--p));
  outline-offset: 2px;
}

.docs-category-items {
  transition: display 0.2s ease-in-out;
}
</style>
{% endblock %}
